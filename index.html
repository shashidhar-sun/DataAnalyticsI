<!DOCTYPE html>
<html>
	<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		html { height: 100% }
		body { height: 100%; margin: 500; padding: 0 }
		#map_canvas { height: 100% }
	</style>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAK-Z0hFMYhpn0Dztr0lU1WhMvwViPPrwc&libraries=places&sensor=false"></script>
	<script type="text/javascript">
		// Global variables and data structures
		var map;
		var service;
		var i;
		var csPlaces = {}; // the array in which you will score crime scores.
		var mar = new Array();
		var loc;
		var ic;
		var infowindow = new Array();
		var marker;


		var csPlace = function(lat, lng) {
			this.latitude = lat;
			this.longitude = lng;
			this.crimescore = -1;
		}


		// Main startup routine
		var initialize = function() 
		{
			addSearchBoxListener();
			var mapOptions = {
				center: new google.maps.LatLng(38.89555, -77.0362),
				zoom: 11,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};


			map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);


			service = new google.maps.places.PlacesService(map);


			google.maps.event.addListener(map, 'click', function(event) 
			{
				// Call the backend for crime score at event.laLng and et the crime score
				var crimescore = 50;


				var a;
				if (crimescore < 10)
					a = "0" + crimescore.toString();
				else
					a = crimescore.toString();


				var b;
				if ((100 - crimescore) < 10)
					b = "0" + (100 - crimescore).toString();
				else
					b = (100 - crimescore).toString();


				var marker = new google.maps.Marker({
					position: event.latLng,
					map: map,
					icon: 'http://www.googlemapsmarkers.com/v1/' + a + b +'00/'
				});
			});
		}


		// Get CrimeScores for an array of lat/lng coordinates
		var getCrimeScores = function(array) {
			coordinates = "coords=" + array.join(",");
			callback = "&callback=?";
			data = coordinates + callback;
			$.getJSON("http://www.crimescore.us:8000/custom/crimescores", data);
		}


		// Get CrimeScore for a single lat/lng
		var getCrimeScore = function(lat, lng) {
			getCrimeScores([lat,lng]);
		}


		// Process returned CrimeScores
		var processCrimeScores = function(data) {


			// Iterate over returned CrimeScores
			for (var i = 0; i < data.places.length ; i++) {
				// Store lat/lng
				var lat = parseFloat(data.places[i].latitude);
				var lng = parseFloat(data.places[i].longitude);


				// Get the id for this lat/lng
				var id = identifierForLatLng(lat, lng);


				// If there wasn't already an entry for this ID, make one
				if (csPlaces[id] === undefined)
					csPlaces[id] = new csPlace(lat, lng);


				// Add CrimeScore to structure
				csPlaces[id].crimescore = parseFloat(data.places[i].crimescore);
				console.log(csPlaces[id]);
                                
                                
						 // Shashi's code
						
						 	
						 		var a;
                                                                var t = Math.floor(csPlaces[id].crimescore);
						 		if ( t< 10)
						 			a = "0" + t.toString();
						 		else
						 			a = t.toString();
						 		
						 		var b;
						 		if ((100 - t) < 10)
						 			b = "0" + (100-t).toString();
						 		else
						 			b = (100 - t).toString();
						 		
                                                                
						 		var url = 'http://www.googlemapsmarkers.com/v1/' + a + b +'00/';
                                                                alert(csPlaces[id].latitude);
                                                                var latlng =new LatLng(csPlaces[id].latitude,csPlaces[id].longitude);
						 	        var marker = new google.maps.Marker({
                                                                                                    position: lstlng ,
                                                                                                    map: map,
                                                                                                    icon: url
                                                                                                    });
                                                                alert("Hello");
						 
						// 
						// for (j = 0; j < loc.length; j++)
						// {
						// 	//alert(j);
						
						// 	
						// 	infowindow[j] = new google.maps.InfoWindow();
						// 	//alert(ic[j]);
						// 	infowindow[j].setContent(cs[j].toString());
						// 	//infowindow[j].open(map, marker[j]);
						// 	google.maps.event.addListener(marker[j], 'click', (function(marker,j)
						// 	{
						// 		return function()
						// 		{
						// 			// alert(j);
						// 			infowindow[j].open(map, marker);
						// 		}  
						// 	}(marker[j],j)));
						// }
			}
		};


		// Generate a system-wide identifier for a lat/lng
		var identifierForLatLng = function(latitude, longitude) {
			latitude = latitude.toString();
			latitude = latitude.replace(/-/g, "");
			latitude = latitude.replace(/\./g, "");
			longitude = longitude.toString();
			longitude = longitude.replace(/-/g, "");
			longitude = longitude.replace(/\./g, "");
			return latitude + longitude + "";
		}


		// Add listener to search box
		var addSearchBoxListener = function() {
			document.getElementById('val').onkeypress = function(e)
			{
				if (!e) e = window.event;   
				if (e.keyCode == '13')
				{


					// // Shashi's code
					// //alert((marker[0].position).toString());
					// if (marker)
					// {
					// 	for (m in marker) {
					// 		marker[m].setMap(null);
					// 		//alert("marker error");
					// 	}
					// 	marker.length = 0;
					// 	loc.length = 0;
					// 	ic.length = 0;
					// }
					// marker = new Array();
					// loc = new Array();
					// ic = new Array();


					// Value of text box
					var address = document.getElementById("val").value;


					// var geocoder = new google.maps.Geocoder();


					var request = {
						// Hardcode location to center of Washington, D.C.
						location: new google.maps.LatLng(38.89555, -77.0362),
						// Text box value
						keyword: address,
						// Radius of 10km
						radius: 10000
					};


					// Send request to service
					service.radarSearch(request, function(results, status)
					{
						var i = 0;


						// Iterate over search results
						for (var j = 0; j < results.length; j++)
						{
							// cs[j] = j;


							// Get latitude/longitude
							var lat = results[j].geometry.location.lat();
							var lng = results[j].geometry.location.lng();


							// Generate an identifier based on coordinates
							var id = identifierForLatLng(lat, lng);


							// Create a new csPlace with coordinates and identifier
							csPlaces[id] = new csPlace(lat, lng);


							// Fire off a request for a CrimeScore for each coordinate
							getCrimeScore(lat, lng);
						}


					});
				}
			}
		};




		// Testing code
		// var testArray = [38.8325192140698,-76.9936390021642,38.90398,-77.05510];
		// getCrimeScores(testArray);
    </script>
	</head>
	<body onload="initialize()">
		<div style="text-align: left;">
			<span style="font-weight: bold;">Please enter the query in the search box or click on a point to find the crime score.&nbsp;<label></label></span>
		</div>
	<div style="text-align: right;">
		<input name="str" id="val" value="search">
	</div>
	<p><br></br></p>


	<div id="map_canvas" style="width:100%; height:100%"></div>


	</body>
</html>
