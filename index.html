<!DOCTYPE html>
<html>
	<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="http://meyerweb.com/eric/tools/css/reset/reset.css">
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
	<link href='http://fonts.googleapis.com/css?family=Rambla:400,700' rel='stylesheet' type='text/css'>
	<style type="text/css">
		html { height: 100% }
		body { height: 100%; margin: 500; padding: 0 }
		#map_canvas {
			position: absolute;
			top: 0;
			width: 100%;
			height: 100%;
			z-index: 0;
		}

		#header {
			position: absolute;
			top: 0;
			left: 4%;
			height: 8%;
			background-color: 
			#a9a;
			z-index: 100;
			border-radius: 15px;
		}

		#header-back {
			position: absolute;
			top: -15px;
			left: 0;
			height: 5%;
			width: 100%;
			background-color: 
			#a9a;
			z-index: 99;
			border-radius: 15px;
			text-align: right;
		}

		#reset {
			position: absolute;
			top: 0;
			right: 0;
			height: 5%;
			width: 10%;
			background-color: transparent;
			z-index: 100;
			text-align: right;
			padding-top: 5px;
			padding-right: 15px;
		}

		#header h1 {
			font-family: 'Rambla', sans-serif;
			font-size: 48px;
			margin: 15px;
			color: #eee;
		}

		#experimentCrimeScoreLogo {
			font-family: 'Rambla', sans-serif;
			font-size: 24px;
			margin: 15px;
			color: #eee;
		}

		#experiment h2 {
			font-family: 'Rambla', sans-serif;
			font-size: 36px;
			margin: 15px;
			color: #eee;
		}

		#search {
			position: absolute;
			top: 6%;
			z-index: 100;
			background-color: #a9a;
			color: #fff;
			border-radius: 10px;
			padding: 7px;
			width: 30%;
			left: 35%;
			text-align: center;
			font-family: sans-serif;
			display: none;
		}

		.placeInfo-name {
			font-family: sans-serif;
			font-size: 20px;
			padding-bottom: 2px;
		}

		.placeInfo-crimescore {
			font-family: sans-serif;
			font-size: 16px;
			padding-bottom: 10px;
		}

		.placeInfo-crimescore-logo {
			color: #a9a;
			font-weight: bolder;
			font-family: 'Rambla', sans-serif;
			padding-right: 8px;
			font-size: 18px;
		}

		.placeInfo-address {
			font-family: sans-serif;
			font-size: small;
			padding-bottom: 10px;
		}

		.placeInfo-removeLink {
			font-family: sans-serif;
			font-size: small;
			padding-bottom: 10px;
		}

		.placeInfo-telephone {
			font-family: sans-serif;
			font-size: small;
		}

		.placeInfo-website {
			font-family: sans-serif;
			font-size: small;
		}

		.placeInfo-url {
			font-family: sans-serif;
			font-size: small;
		}

		.placeInfo-rating {
			font-family: sans-serif;
			font-size: small;
		}

		.placeInfo-image {
			display: block;
			float: left;
		}

		.placeInfo-image img {
			width: 100px;
		}

		input#searchBox {
			width: 55%;
			line-height: 24px;
		}

		td {
			vertical-align: top;
			padding-right: 24px;
		}

		#experiment {
			position: absolute;
			top: 10%;
			right: 5%;
			z-index: 500;
			height: 80%;
			background: #a9a;
			width: 20%;
			border-radius: 15px;
			padding: 15px;
			display: none;
			text-align: center;
			overflow: scroll;
		}

		#sandbox {
			z-index: 501;
			width: 100%;
			height: 100%;
			display: block;
		}

		.slider {
			width: 90%;
			margin: 5%;
			margin-top: 2px;
		}

		.parmLo {
			display: block;
			float: left;
			line-height: 24px;
		}

		.parmHi {
			display: block;
			float: left;
			clear: right;
			line-height: 24px;
		}

		.parmLabel, .parmValue {
			display: block;
			float: middle;
			clear: both;
		}
	</style>
	<script src="javascript/d3.v2.min.js" type="text/javascript"></script>
	<script src="javascript/jquery-1.8.3.min.js" type="text/javascript"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js" type="text/javascript"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAK-Z0hFMYhpn0Dztr0lU1WhMvwViPPrwc&libraries=places&sensor=false"></script>
	<script type="text/javascript">
		// Global variables and data structures
		var map;
		var service;
		var i;
		var csPlaces = {}; // the array in which you will score crime scores.
		var mar = new Array();
		var loc;
		var ic;
		var infowindow = new Array();
		var marker = new Array();
		var detailSearchTimers = new Array();
		var demoNumber = 0;

		var csPlace = function(lat, lng) {
			this.latitude = lat;
			this.longitude = lng;
			this.crimescore = -1;
			this.reference = -1;
			this.details = -1;
		}

		var explorePlace = {};

		// Main startup routine
		var initialize = function() 
		{
			$("#search").fadeIn(500);

			addSearchBoxListener();
			var mapOptions = {
				center: new google.maps.LatLng(38.89555, -77.0362),
				disableDefaultUI: true,
				zoomControl: true,
				zoomControlOptions: { position: google.maps.ControlPosition.LEFT_CENTER },
				zoom: 11,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};

			map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
			service = new google.maps.places.PlacesService(map);
		}

		var launchExplore = function() {
			$("#search").fadeOut(500);
			$("#experiment").fadeIn(500);
			$(".slider").slider();
			$("#experimentPointSelect").click(selectExperimentPoint);
			$(".slider").on("slide", handleSliderChange);
		};

		var selectExperimentPoint = function() {
			removeMarkers();

			google.maps.event.addListenerOnce(map, 'click', function(event) {
				csPlaces = {};

				map.setCenter(event.latLng);
				var latitude = event.latLng.lat();
				var longitude = event.latLng.lng();
				var id = identifierForLatLng(latitude, longitude);
				csPlaces[id] = new csPlace(latitude, longitude);
				getCrimeScore(latitude, longitude);

				// Color interpolator
				var greenRedInterpolator = d3.interpolateHsl("#00FF00", "#FF0000");

				if (demoNumber == 0) {
					var slider1Value = 108;
					var slider1Min = 1;
					var slider1Max = 108;
					$("#slider1").slider("option", "min", slider1Min);
					$("#slider1").slider("option", "max", slider1Max);
					$("#slider1").slider("value", slider1Value);
					$("#parm1Value").text("1.08");

					var slider2Value = 0;
					var slider2Min = 0;
					var slider2Max = 100;
					$("#slider2").slider("option", "min", slider2Min);
					$("#slider2").slider("option", "max", slider2Max);
					$("#slider2").slider("value", slider2Value);

					var slider3Value = 0;
					var slider3Min = 0;
					var slider3Max = 100;
					$(".slider").on("slide", function(event, ui) {});
					$("#slider3").slider("option", "min", slider3Min);
					$("#slider3").slider("option", "max", slider3Max);
					$("#slider3").slider("value", slider3Value);
					$(".slider").on("slide", handleSliderChange);

					var slider4Value = 0;
					var slider4Min = 0;
					var slider4Max = 100;
					$(".slider").on("slide", function(event, ui) {});
					$("#slider4").slider("option", "min", slider4Min);
					$("#slider4").slider("option", "max", slider4Max);
					$("#slider4").slider("value", slider4Value);
					$(".slider").on("slide", handleSliderChange);

					var slider5Value = 0;
					var slider5Min = 0;
					var slider5Max = 100;
					$(".slider").on("slide", function(event, ui) {});
					$("#slider5").slider("option", "min", slider5Min);
					$("#slider5").slider("option", "max", slider5Max);
					$("#slider5").slider("value", slider5Value);
					$(".slider").on("slide", handleSliderChange);

					var slider6Value = 0;
					var slider6Min = 0;
					var slider6Max = 100;
					$(".slider").on("slide", function(event, ui) {});
					$("#slider6").slider("option", "min", slider6Min);
					$("#slider6").slider("option", "max", slider6Max);
					$("#slider6").slider("value", slider6Value);
					$(".slider").on("slide", handleSliderChange);
				} else if (demoNumber == 1) {
					var c;
				}

				demoNumber++;
			});
		}

		var handleSliderChange = function(event, ui) {
			var id = event.target.id.substring(event.target.id.length-1);
			var value = parseFloat(ui.value) / 100;
			$("#parm" + id + "Value").text(value.toString());
		};

		// Get CrimeScores for an array of lat/lng coordinates
		var getCrimeScores = function(array) {
			coordinates = "coords=" + array.join(",");
			callback = "&callback=?";
			data = coordinates + callback;
			$.getJSON("http://www.crimescore.us:8000/custom/crimescores", data);
		}

		// Get CrimeScore for a single lat/lng
		var getCrimeScore = function(lat, lng) {
			getCrimeScores([lat,lng]);
		}

		var removeMarkers = function() {
			for (var elem in csPlaces) {
				if (csPlaces[elem].marker) {
					csPlaces[elem].marker.setMap(null);
					delete csPlaces[elem];
				}
			}
		};

		var removeMarker = function(id) {
			if (csPlaces[id]) {
				csPlaces[id].marker.setMap(null);
				delete csPlaces[id];
			}
		}

		// Process returned CrimeScores
		var processCrimeScores = function(data) {


			// Iterate over returned CrimeScores
			for (var i = 0; i < data.places.length ; i++) {
				// Store lat/lng
				var lat = parseFloat(data.places[i].latitude);
				var lng = parseFloat(data.places[i].longitude);


				// Get the id for this lat/lng
				var id = identifierForLatLng(lat, lng);


				// If there wasn't already an entry for this ID, make one
				if (csPlaces[id] === undefined)
					csPlaces[id] = new csPlace(lat, lng);

				var threshold = $("#crimeScoreThreshold").val();

				// Local pointer to csPlaces entry
				var place = csPlaces[id];

				// Add CrimeScore to structure
				place.crimescore = parseFloat(data.places[i].crimescore);

				if (place.crimescore < threshold) {

					// Temporarily set sandbox CrimeScore here
					$("#experimentCrimeScoreLogo").text("CrimeScore: " + place.crimescore.toFixed(4).toString());

					// Color interpolator
					var greenRedInterpolator = d3.interpolateHsl("#00FF00", "#FF0000");
					var scaledCrimeScore = place.crimescore / 100;


					var url = 'http://www.googlemapsmarkers.com/v1/' + greenRedInterpolator(scaledCrimeScore).substring(1) +'/';
					var latLng = new google.maps.LatLng(place.latitude, place.longitude);
					place.marker = new google.maps.Marker({
						position: latLng,
						map: map,
						icon: url
					});

					var html = ""

					var columns = 0;

					if (place.details != -1) {
						if (place.details.name)
							html += "<div class='placeInfo-name'>" + place.details.name + "</div>";
						if (place.details.formatted_address)
							html += "<div class='placeInfo-address'>" + place.details.formatted_address + "</div>";

						html += "<div class='placeInfo-crimescore'><span class='placeInfo-crimescore-logo'>CrimeScore</span>" + Math.round(place.crimescore) + "</div>";
						html += "<div class='placeInfo-removeLink'><a href=\"javascript:removeMarker('" + identifierForLatLng(place.latitude, place.longitude) + "')\">Remove from Map</a></div>";
						html += "<table><tr>"

						if (place.details && place.details.photos)
							html += "<td><div class='placeInfo-image'><img src='" + place.details.photos[0].raw_reference.fife_url + "' /></div></td>";

						if (place.details.formatted_phone_number) {
							if (columns == 0) {
								html += "<td><table>"
								columns++;
							}
							html += "<tr><td><div class='placeInfo-telephone'>Telephone: " + place.details.formatted_phone_number + "</div></td></tr>";
						}
						if (place.details.rating) {
							if (columns == 0) {
								html += "<td><table>"
								columns++;
							}
							html += "<tr><td><div class='placeInfo-rating'>Rating: " + place.details.rating + "</div></td></tr>";
						}
						if (place.details.url) {
							if (columns == 0) {
								html += "<td><table>"
								columns++;
							}
							html += "<tr><td><div class='placeInfo-url'><a href='" + place.details.url + "'>Google+</a></div></td></tr>";
						}
						if (place.details.website) {
							if (columns == 0) {
								html += "<td><table>"
								columns++;
							}
							html += "<tr><td><div class='placeInfo-website'><a href='" + place.details.website + "'>Website</a></div></td></tr>";
						}

						if (columns > 0) {
							html += "</td></table>"
							columns++;
						}

						html += "</tr></table>";

					} else {
						html += "<div class='placeInfo-crimescore'><span class='placeInfo-crimescore-logo'>CrimeScore</span>" + Math.round(place.crimescore) + "</div>";
						html += "<div class='placeInfo-removeLink'><a href=\"javascript:removeMarker('" + identifierForLatLng(place.latitude, place.longitude) + "')\">Remove from Map</a></div>";
					}

					place.infoWindow = new google.maps.InfoWindow({content: html});
					google.maps.event.addListener(place.marker, 'click', function() {
						place.infoWindow.open(map, place.marker);
					});
				} else {
					delete csPlaces[id];
				}
			}
		};

		// Generate a system-wide identifier for a lat/lng
		var identifierForLatLng = function(latitude, longitude) {
			latitude = latitude.toString();
			latitude = latitude.replace(/-/g, "");
			latitude = latitude.replace(/\./g, "");
			longitude = longitude.toString();
			longitude = longitude.replace(/-/g, "");
			longitude = longitude.replace(/\./g, "");
			return latitude + longitude + "";
		}

		// Add listener to search box
		var addSearchBoxListener = function() {			
			document.getElementById("searchBox").onkeypress = function(e) {
				if (!e) e = window.event;
				if (e.keyCode == '13')
					processSearchBox();
			};
			$("#submitSearch").click(processSearchBox);
		};

		var processSearchBox = function() {
			// Value of text box
			var address = document.getElementById("searchBox").value;

			var request = {
				// Hardcode location to center of Washington, D.C.
				location: new google.maps.LatLng(38.89555, -77.0362),
				// Text box value
				keyword: address,
				// Radius of 10km
				radius: 10000
			};

			// Send request to service
			service.radarSearch(request, processPlaceSearchResult);
		};

		var resetAll = function() {
			for (var i = 0; i < detailSearchTimers.length; i++) {
				clearInterval(detailSearchTimers[i]);
			}
			setTimeout(removeMarkers, 1000);
		};

		var processPlaceSearchResult = function(results, status) {
			var i = 0;
			var j = 0;
			while (i < results.length) {
				var toProcess = [];
				for (var k = 0; k < 5; k++) {
					toProcess.push(results[i]);
					i++;
				}

				getPlaceDetailsAfterDelay(toProcess, j * 3000);
				j++;
			}
		};

		var getPlaceDetailsAfterDelay = function(results, delay) {
			var timer = setTimeout(function() {
				for (var i = 0; i < results.length; i++) {
					service.getDetails({reference: results[i].reference}, processPlaceDetailSearchResult);
				}
			}, delay);

			detailSearchTimers.push(timer);
		};

		var processPlaceDetailSearchResult = function(place, status) {
			if (status != google.maps.places.PlacesServiceStatus.OK) {
				console.log(status);
				return;
			}

			if (typeof(place) == "object" && place.geometry) {
				var lat = place.geometry.location.lat();
				var lng = place.geometry.location.lng();
				var id = identifierForLatLng(lat, lng);

				// Create a new csPlace with coordinates and identifier
				csPlaces[id] = new csPlace(lat, lng);
				// csPlaces[id].reference = results[j].reference;
				csPlaces[id].details = place;

				// Fire off a request for a CrimeScore for each coordinate
				getCrimeScore(lat, lng);
			}
		};


		// Testing code
		// var testArray = [38.8325192140698,-76.9936390021642,38.90398,-77.05510];
		// getCrimeScores(testArray);
    </script>
	</head>
	<body onload="initialize()">
		<div id="header">
			<h1>CrimeScore</h1>
			<!--
			<div id="modeSelect">
				<h2>Choose a mode: <a href="#">Plan</a> | <a href="#">Explore</a></h2>
			</div>
			<span style="font-weight: bold;">Please enter the query in the search box or click on a point to find the crime score.&nbsp;<label></label></span>
			-->
		</div>
		<div id="header-back"></div>
		<div id="reset"><a href="javascript:resetAll()">Reset</a></div>
		<div id="search">
			Search for anything <input id="searchBox"><input type="submit" id="submitSearch" value="Go" /><br />
			with a CrimeScore below
			<select name="crimeScoreThreshold" id="crimeScoreThreshold">
				<option name="100" selected=true>100</option>
				<option name="99">99</option>
				<option name="98">98</option>
				<option name="97">97</option>
				<option name="96">96</option>
				<option name="95">95</option>
				<option name="94">94</option>
				<option name="93">93</option>
				<option name="92">92</option>
				<option name="91">91</option>
				<option name="90">90</option>
				<option name="89">89</option>
				<option name="88">88</option>
				<option name="87">87</option>
				<option name="86">86</option>
				<option name="85">85</option>
				<option name="84">84</option>
				<option name="83">83</option>
				<option name="82">82</option>
				<option name="81">81</option>
				<option name="80">80</option>
				<option name="79">79</option>
				<option name="78">78</option>
				<option name="77">77</option>
				<option name="76">76</option>
				<option name="75">75</option>
				<option name="74">74</option>
				<option name="73">73</option>
				<option name="72">72</option>
				<option name="71">71</option>
				<option name="69">69</option>
				<option name="68">68</option>
				<option name="67">67</option>
				<option name="66">66</option>
				<option name="65">65</option>
				<option name="64">64</option>
				<option name="63">63</option>
				<option name="62">62</option>
				<option name="61">61</option>
				<option name="60">60</option>
				<option name="59">59</option>
				<option name="58">58</option>
				<option name="57">57</option>
				<option name="56">56</option>
				<option name="55">55</option>
				<option name="54">54</option>
				<option name="53">53</option>
				<option name="52">52</option>
				<option name="51">51</option>
				<option name="50">50</option>
				<option name="49">49</option>
				<option name="48">48</option>
				<option name="47">47</option>
				<option name="46">46</option>
				<option name="45">45</option>
				<option name="44">44</option>
				<option name="43">43</option>
				<option name="42">42</option>
				<option name="41">41</option>
				<option name="40">40</option>
				<option name="39">39</option>
				<option name="38">38</option>
				<option name="37">37</option>
				<option name="36">36</option>
				<option name="35">35</option>
				<option name="34">34</option>
				<option name="33">33</option>
				<option name="32">32</option>
				<option name="31">31</option>
				<option name="30">30</option>
				<option name="29">29</option>
				<option name="28">28</option>
				<option name="27">27</option>
				<option name="26">26</option>
				<option name="25">25</option>
				<option name="24">24</option>
				<option name="23">23</option>
				<option name="22">22</option>
				<option name="21">21</option>
				<option name="20">20</option>
				<option name="19">19</option>
				<option name="18">18</option>
				<option name="17">17</option>
				<option name="16">16</option>
				<option name="15">15</option>
				<option name="14">14</option>
				<option name="13">13</option>
				<option name="12">12</option>
				<option name="11">11</option>
				<option name="10">10</option>
				<option name="9">9</option>
				<option name="8">8</option>
				<option name="7">7</option>
				<option name="6">6</option>
				<option name="5">5</option>
				<option name="4">4</option>
				<option name="2">2</option>
				<option name="1">1</option>
			</select>
			or choose <a href="javascript:launchExplore()" >Experiment</a> mode.
		</div>
		<div id="planner"></div>
		<div id="experiment">
			<h2>Experiment Tool</h2>
			<input type="submit" id="experimentPointSelect" value="Select a point">
			<div id="sandbox">
				<div id="experimentCrimeScoreLogo"></div>
				
				<div class="parmLabel">Liquor Store Count</div>
				<div class="parmValue" id="parm1Value">0</div>
				<div id="slider1" class="slider"></div>
				
				<div class="parmLabel">Bank Count</div>
				<div class="parmValue" id="parm2Value">0</div>
				<div id="slider2" class="slider"></div>
				
				<div class="parmLabel">Barber Shop Count</div>
				<div class="parmValue" id="parm3Value">0</div>
				<div id="slider3" class="slider"></div>
				
				<div class="parmLabel">Car Lot Count</div>
				<div class="parmValue" id="parm4Value">0</div>
				<div id="slider4" class="slider"></div>
				
				<div class="parmLabel">Dorm Count</div>
				<div class="parmValue" id="parm5Value">0</div>
				<div id="slider5" class="slider"></div>
				
				<div class="parmLabel">School Count</div>
				<div class="parmValue" id="parm6Value">0</div>
				<div id="slider6" class="slider"></div>
				
				<div class="parmLabel">Embassy Count</div>
				<div class="parmValue" id="parm7Value">0</div>
				<div id="slider7" class="slider"></div>
				
				<div class="parmLabel">Hospital Count</div>
				<div class="parmValue" id="parm8Value">0</div>
				<div id="slider8" class="slider"></div>
				
				<div class="parmLabel">Hotel Count</div>
				<div class="parmValue" id="parm9Value">0</div>
				<div id="slider9" class="slider"></div>
				
				<div class="parmLabel">Industrial Area Count</div>
				<div class="parmValue" id="parm10Value">0</div>
				<div id="slider10" class="slider"></div>
				
				<div class="parmLabel">Museum Count</div>
				<div class="parmValue" id="parm11Value">0</div>
				<div id="slider11" class="slider"></div>
				
				<div class="parmLabel">Recreation Area Count</div>
				<div class="parmValue" id="parm12Value">0</div>
				<div id="slider12" class="slider"></div>
				
				<div class="parmLabel">Religious Establishment Count</div>
				<div class="parmValue" id="parm13Value">0</div>
				<div id="slider13" class="slider"></div>
				
				<div class="parmLabel">Vacant Lot Count</div>
				<div class="parmValue" id="parm14Value">0</div>
				<div id="slider14" class="slider"></div>
				
				<div class="parmLabel">Auto Repair Countt</div>
				<div class="parmValue" id="parm15Value">0</div>
				<div id="slider15" class="slider"></div>
				
				<div class="parmLabel">Distance to Military Installation</div>
				<div class="parmValue" id="parm16Value">0</div>
				<div id="slider16" class="slider"></div>
				
				<div class="parmLabel">Distance to Police Station</div>
				<div class="parmValue" id="parm17Value">0</div>
				<div id="slider17" class="slider"></div>
				
				<div class="parmLabel">Distance to Public Housing</div>
				<div class="parmValue" id="parm18Value">0</div>
				<div id="slider18" class="slider"></div>

				
			</div>
		</div>
		<div id="map_canvas"></div>
	</body>
</html>