	<!DOCTYPE html>
	<html>
	<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		html { height: 100% }
		body { height: 100%; margin: 500; padding: 0 }
		#map_canvas { height: 100% }
	</style>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAK-Z0hFMYhpn0Dztr0lU1WhMvwViPPrwc&libraries=places&sensor=false"></script>
	<script type="text/javascript">
		// Global variables and data structures
		var map;
		var service;
		var i;
		var csPlaces = {}; // the array in which you will score crime scores.
		
		var csPlace = function(lat, lng) {
			this.latitude = lat;
			this.longitude = lng;
			this.crimescore = -1;
		}
		
		// Main startup routine
		var initialize = function() 
		{
			addSearchBoxListener();
			var mapOptions = {
				center: new google.maps.LatLng(38.89555, -77.0362),
				zoom: 11,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			
			map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

			service = new google.maps.places.PlacesService(map);

			google.maps.event.addListener(map, 'click', function(event) 
			{
				// Call the backend for crime score at event.laLng and et the crime score
				var crimescore = 50;
				
				var a;
				if (crimescore < 10)
					a = "0" + crimescore.toString();
				else
					a = crimescore.toString();
				
				var b;
				if ((100 - crimescore) < 10)
					b = "0" + (100 - crimescore).toString();
				else
					b = (100 - crimescore).toString();
					
				var marker = new google.maps.Marker({
					position: event.latLng,
					map: map,
					icon: 'http://www.googlemapsmarkers.com/v1/' + a + b +'00/'
				});
			});
		}
		
		// Get CrimeScores for an array of lat/lng coordinates
		var getCrimeScores = function(array) {
			coordinates = "coords=" + array.join(",");
			callback = "&callback=?";
			data = coordinates + callback;
			console.log(data);
			$.getJSON("http://www.crimescore.us:8000/custom/crimescores", data);
		}
		
		// Get CrimeScore for a single lat/lng
		var getCrimeScore = function(lat, lng) {
			getCrimeScores([lat,lng]);
		}
		
		// Process returned CrimeScores
		var processCrimeScores = function(data) {
			
			// Iterate over returned CrimeScores
			for (var i = 0; i < data.places.length; i++) {
				// Store lat/lng
				var lat = parseFloat(data.places[i].latitude);
				var lng = parseFloat(data.places[i].longitude);
				
				// Get the id for this lat/lng
				var id = identifierForLatLng(lat, lng);
				
				// If there wasn't already an entry for this ID, make one
				if (csPlaces[id] === undefined)
					csPlaces[id] = new csPlace(lat, lng);
				
				// Add CrimeScore to structure
				csPlaces[id].crimescore = parseFloat(data.places[i].crimescore);
				console.log(csPlaces[id]);
			}
		};
		
		// Generate a system-wide identifier for a lat/lng
		var identifierForLatLng = function(latitude, longitude) {
			latitude = latitude.toString();
			latitude = latitude.replace(/-/g, "");
			latitude = latitude.replace(/\./g, "");
			longitude = longitude.toString();
			longitude = longitude.replace(/-/g, "");
			longitude = longitude.replace(/\./g, "");
			return latitude + longitude + "";
		}
		
		// Add listener to search box
		var addSearchBoxListener = function() {
			document.getElementById('val').onkeypress = function(e)
			{
				if (!e) e = window.event;   
				if (e.keyCode == '13')
				{
					// Value of text box
					var address = document.getElementById("val").value;
				
					// var geocoder = new google.maps.Geocoder();
				
					var request = {
						// Hardcode location to center of Washington, D.C.
						location: new google.maps.LatLng(38.89555, -77.0362),
						// Text box value
						keyword: address,
						// Radius of 10km
						radius: 10000
					};
				
					// Send request to service
					service.radarSearch(request, function(results, status)
					{
						i = 0;
					
						// Iterate over search results
						for (var j = 0; j < results.length; j++)
						{
							// cs[j] = j;
						
							// Get latitude/longitude
							var lat = results[j].geometry.location.lat();
							var lng = results[j].geometry.location.lng();
						
							// Generate an identifier based on coordinates
							var id = identifierForLatLng(lat, lng);
						
							// Create a new csPlace with coordinates and identifier
							csPlaces[id] = new csPlace(lat, lng);
						
							// Fire off a request for a CrimeScore for each coordinate
							getCrimeScore(lat, lng);
						}
					
						// for(i = 0; i < results.length; i++)
						// {
						// 	var req = {reference: results[i].reference};
						// 	if (i < 9)
						// 	{
						// 		service.getDetails(req, function(place, stat)
						// 		{
						// 			if (typeof service.getDetails.i == 'undefined')
						// 			{
						// 				service.getDetails.i = 0;
						// 			}
						// 			
						// 			var a;
						// 			if (cs[service.getDetails.i] < 10)
						// 				a = "0" + cs[service.getDetails.i].toString();
						// 			else
						// 				a = cs[service.getDetails.i].toString();
						// 			var b;
						// 			
						// 			if ((100 - cs[service.getDetails.i]) < 10)
						// 				b = "0" + (100 - cs[service.getDetails.i]).toString();
						// 			else
						// 				b = (100 - cs[service.getDetails.i]).toString();
						// 			
						// 			service.getDetails.i++;
						// 			
						// 			if (stat == google.maps.places.PlacesServiceStatus.OK)
						// 			{
						// 				
						// 				//Call back end for crime score at place.geometry.location
						// 				var beachMarker = new google.maps.Marker({
						// 					position: place.geometry.location,
						// 					map: map,
						// 					icon: 'http://www.googlemapsmarkers.com/v1/' + a + b +'00/'
						// 				});
						// 			}
						// 		});
						// 	}
						// 	
						// 	else
						// 	{
						// 		var a;
						// 		if (cs[i] < 10)
						// 			a = "0" + cs[i].toString();
						// 		else
						// 			a = cs[i].toString();
						// 		
						// 		var b;
						// 		if ((100 - cs[i]) < 10)
						// 			b = "0" + (100-cs[i]).toString();
						// 		else
						// 			b = (100 - cs[i]).toString();
						// 		
						// 		var beachMarker = new google.maps.Marker({
						// 			position: results[i].geometry.location,
						// 			map: map,
						// 			icon: 'http://www.googlemapsmarkers.com/v1/' + a + b +'00/'
						// 		});
						// 	}
						// }
					});
				}
			}
		}
		
		
		// Testing code
		var testArray = [38.8325192140698,-76.9936390021642,38.90398,-77.05510];
		getCrimeScores(testArray);
    </script>
	</head>
	<body onload="initialize()">
		<div style="text-align: left;">
			<span style="font-weight: bold;">Please enter the query in the search box or click on a point to find the crime score.&nbsp;<label></label></span>
		</div>
	<div style="text-align: right;">
		<input name="str" id="val" value="search">
	</div>
	<p><br></br></p>
	
	<div id="map_canvas" style="width:100%; height:100%"></div>
	
	</body>
</html>
